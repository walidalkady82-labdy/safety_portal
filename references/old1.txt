import 'dart:async';
import 'dart:math';

import 'package:flutter/material.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:firebase_database/firebase_database.dart';
import 'package:fl_chart/fl_chart.dart';
import 'package:safety_portal/core/themes.dart';
import 'package:safety_portal/data/service/service_ai.dart';
import 'package:safety_portal/data/service/service_analytics.dart';
import 'package:safety_portal/presentation/auth/auth_wrapper.dart';

class ScreenHome extends StatefulWidget {
  const ScreenHome({super.key});

  @override
  State<ScreenHome> createState() => _ScreenHomeState();
}

class _ScreenHomeState extends State<ScreenHome> {
  int _selectedIndex = 0; 

  // --- LOCALIZATION STATE ---
  bool _isArabic = false; // Default to English

  String get _currentLang => _isArabic ? 'ar' : 'en';

  void _toggleLanguage() {
    setState(() {
      _isArabic = !_isArabic;
    });
  }

  // Dictionary for Static Text
  final Map<String, Map<String, String>> _vocab = {
    // Navigation
    'nav_analytics': {'en': 'Analytics', 'ar': 'التحليلات'},
    'nav_new_report': {'en': 'New Report', 'ar': 'بلاغ جديد'},
    'nav_profile': {'en': 'Profile', 'ar': 'ملفي'},

    // Dashboard
    'dash_no_data': {'en': 'No Data Available', 'ar': 'لا توجد بيانات'},
    'dash_retry': {'en': 'Retry', 'ar': 'إعادة المحاولة'},
    'dash_perf_card': {'en': 'My Performance', 'ar': 'أدائي الشخصي'},
    'dash_submitted': {'en': 'Submitted', 'ar': 'المقدمة'},
    'dash_pending': {'en': 'Pending', 'ar': 'قيد الانتظار'},
    'dash_closed': {'en': 'Closed', 'ar': 'مغلقة'},
    'dash_risk_levels': {'en': 'Risk Levels', 'ar': 'مستويات المخاطر'},
    'dash_issue_types': {'en': 'Issue Types', 'ar': 'أنواع البلاغات'},
    'dash_hazard_kinds': {'en': 'Hazard Kinds Detected', 'ar': 'أنواع المخاطر المكتشفة'},
    'dash_elec_issues': {'en': 'Electrical Issues', 'ar': 'الأعطال الكهربائية'},
    'dash_hotspots': {'en': 'Risk Hotspots (By Area)', 'ar': 'أماكن الخطر (حسب المنطقة)'},
    'dash_team_rates': {'en': 'Team Closure Rates', 'ar': 'معدلات إغلاق الفرق'},

    // Form
    'form_title': {'en': 'New Observation', 'ar': 'ملاحظة جديدة'},
    'form_subtitle': {'en': 'AI will auto-classify & check for duplicates', 'ar': 'سيقوم الذكاء الاصطناعي بالتصنيف وكشف التكرار'},
    'form_area': {'en': 'Area / Location', 'ar': 'المنطقة / الموقع'},
    'form_desc_hint': {'en': 'Describe the issue...', 'ar': 'وصف المشكلة...'},
    'form_dup_found': {'en': 'Potential Duplicate Found', 'ar': 'احتمال وجود تكرار'},
    'form_ai_section': {'en': 'AI Classification', 'ar': 'تصنيف الذكاء الاصطناعي'},
    'form_risk_level': {'en': 'Risk Level', 'ar': 'مستوى الخطر'},
    'form_type': {'en': 'Type', 'ar': 'النوع'},
    'form_hazard_kind': {'en': 'Hazard Kind (AI Detected)', 'ar': 'نوع الخطر (اكتشاف AI)'},
    'form_elec_kind': {'en': 'Electrical Kind (AI Detected)', 'ar': 'نوع العطل الكهربائي (اكتشاف AI)'},
    'form_dept': {'en': 'Responsible Dept', 'ar': 'القسم المسؤول'},
    'form_submit': {'en': 'Submit Report', 'ar': 'إرسال البلاغ'},
    'form_fill_error': {'en': 'Please fill Area and Description', 'ar': 'يرجى ملء المنطقة والوصف'},
    'form_success': {'en': 'Report Submitted!', 'ar': 'تم إرسال البلاغ بنجاح!'},

    // General
    'app_title': {'en': 'Safety Portal AI', 'ar': 'بوابة السلامة الذكية'},
    'guest': {'en': 'Guest', 'ar': 'زائر'},
    'role': {'en': 'Safety Portal User', 'ar': 'مستخدم البوابة'},
    'edit_profile': {'en': 'Edit Profile', 'ar': 'تعديل الملف'},
  };

  String t(String key) => _vocab[key]?[_currentLang] ?? key;

  // Dictionary for Dynamic Dropdown Values (Display vs Value)
  final Map<String, String> _areaTr = {
    "CCR": "غرفة التحكم", "Workshop": "الورشة", "Quarry": "المحجر", 
    "Packer": "التعبئة", "Mills": "المطاحن", "Kiln": "الفرن", 
    "Preheater": "البرج", "General": "عام"
  };

  final Map<String, String> _deptTr = {
    "Electrical": "كهرباء", "Mechanical": "ميكانيكا", 
    "Safety": "السلامة", "Production": "إنتاج", "General": "عام"
  };

  final Map<String, String> _typeTr = {
    "Unsafe_Condition": "حالة غير آمنة", "Unsafe_Behavior": "سلوك غير آمن", 
    "NM": "وشيك", "FA": "إسعافات"
  };

  final Map<String, String> _levelTr = {
    "Low": "منخفض", "Medium": "متوسط", "High": "عالي"
  };

  String trVal(String? val, Map<String, String> map) {
    if (val == null) return "";
    return _isArabic ? (map[val] ?? val) : val;
  }


  // --- ANALYTICS STATE ---
  bool _loadingAnalytics = false;
  List<RiskMetric> _areaRisks = [];
  List<TeamMetric> _teamPerformance = [];
  
  // New Analytics State
  List<CategoryMetric> _typeStats = [];
  List<CategoryMetric> _levelStats = [];
  List<CategoryMetric> _hazardStats = [];
  List<CategoryMetric> _elecStats = [];
  UserStat? _userPerformance;
  
  // Stored for Client-Side Duplicate Checking
  List<Map<String, dynamic>> _existingReports = [];

  String _errorMsg = "";

  // --- FORM STATE ---
  final TextEditingController _observationController = TextEditingController();
  Timer? _debounce;
  List<double>? _currentVector;
  String? _duplicateWarning;
  double _similarityScore = 0.0;
  bool _isAnalyzing = false;
  bool isSubmitting = false;

  // Dropdowns
  final List<String> _areas = ["CCR", "Workshop", "Quarry", "Packer", "Mills", "Kiln", "Preheater", "General"];
  final List<String> _departments = ["Electrical", "Mechanical", "Safety", "Production", "General"];
  
  String? selectedArea;
  String? selectedDept;
  String? selectedType; 
  String? selectedHazardKind; 
  String? selectedElectricalKind; 
  String? selectedLevel; 

  @override
  void initState() {
    super.initState();
    _refreshAnalytics();
  }

  @override
  void dispose() {
    _debounce?.cancel();
    _observationController.dispose();
    super.dispose();
  }

  // --- DATA FETCHING ---
  Future<void> _refreshAnalytics() async {
    if (!mounted) return;
    setState(() {
      _loadingAnalytics = true;
      _errorMsg = "";
    });
    
    try {
      final user = FirebaseAuth.instance.currentUser;
      // Pass email as ID because 'reporter' field stores email
      final data = await ServiceAnalytics().getFullDashboardData(user?.email);
      
      if (mounted) {
        setState(() {
          _areaRisks = data['areaRisks'] ?? [];
          _teamPerformance = data['teamPerformance'] ?? [];
          
          _typeStats = data['typeBreakdown'] ?? [];
          _levelStats = data['levelBreakdown'] ?? [];
          _hazardStats = data['hazardBreakdown'] ?? [];
          _elecStats = data['electricalBreakdown'] ?? [];
          _userPerformance = data['userStats'];
          
          _existingReports = data['existingVectors'] ?? [];

          if (_areaRisks.isEmpty && _teamPerformance.isEmpty) {
            _errorMsg = _isArabic ? "لا توجد بيانات في قاعدة البيانات" : "No data found in 'atr' database node.";
          }
        });
      }
    } catch (e) {
      if (mounted) setState(() => _errorMsg = e.toString());
    } finally {
      if (mounted) setState(() => _loadingAnalytics = false);
    }
  }

  // --- AI LOGIC & DUPLICATE DETECTION ---
  void _onObservationChanged(String text) {
    if (_debounce?.isActive ?? false) _debounce!.cancel();
    _debounce = Timer(const Duration(milliseconds: 800), () async {
      if (text.isEmpty) {
        setState(() => _duplicateWarning = null);
        return;
      }

      setState(() => _isAnalyzing = true);

      try {
        // FIX: Pass selectedArea as a named parameter 'area'
        final result = await ServiceAI().analyzeFull(text, area: selectedArea);
        
        final classification = result['classification'] as Map<String, String>;
        final vector = result['embedding'] as List<double>;

        await _checkForDuplicates(vector);

        if (mounted) {
          setState(() {
            selectedType = classification['type'];
            selectedHazardKind = classification['hazard_kind'];
            selectedElectricalKind = classification['electrical_kind'];
            selectedLevel = classification['level'];
            _currentVector = vector;
            _isAnalyzing = false;
          });
        }
      } catch (e) {
        print("Analysis Error: $e");
        if (mounted) setState(() => _isAnalyzing = false);
      }
    });
  }

  Future<void> _checkForDuplicates(List<double> currentVector) async {
    final ref = FirebaseDatabase.instance.ref('atr');
    final snapshot = await ref.get();
    
    if (!snapshot.exists) return;

    double maxSim = 0.0;
    String matchText = "";

    final data = snapshot.value as Map;
    data.forEach((k, v) {
      if (v['vector'] != null) {
        List<double> storedVec = List<double>.from((v['vector'] as List).map((e) => (e as num).toDouble()));
        double sim = ServiceAI().duplicateDetector.calculateSimilarity(currentVector, storedVec);
        if (sim > maxSim) {
          maxSim = sim;
          matchText = v['observationOrIssueOrHazard'] ?? "";
        }
      }
    });

    if (mounted) {
      setState(() {
        _duplicateWarning = maxSim > 0.85 ? "Similar report exists: $matchText" : null;
      });
    }
  }
  // --- SUBMISSION ---
  Future<void> _submitReport() async {
    if (_observationController.text.isEmpty || selectedArea == null) {
      ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text(t('form_fill_error'))));
      return;
    }

    setState(() => isSubmitting = true);
    try {
      final user = FirebaseAuth.instance.currentUser;
      final ref = FirebaseDatabase.instance.ref('atr').push();
      
      await ref.set({
        'area': selectedArea,
        'observationOrIssueOrHazard': _observationController.text,
        'status': 'Pending',
        'issueDate': DateTime.now().toIso8601String(),
        'type': selectedType ?? "Unsafe_Condition",
        'hazard_kind': selectedHazardKind ?? "General",
        'electrical_kind': selectedElectricalKind ?? "Other",
        'level': selectedLevel ?? "Low",
        'respDepartment': selectedDept ?? "Safety",
        'reporter': user?.email ?? "Anonymous",
        'vector': _currentVector ?? [],
      });

      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(SnackBar(backgroundColor: Colors.green, content: Text(t('form_success'))));
        _observationController.clear();
        setState(() {
          selectedType = null;
          selectedLevel = null;
          selectedHazardKind = null;
          selectedElectricalKind = null;
          _currentVector = null;
          _duplicateWarning = null;
          _similarityScore = 0.0;
          _selectedIndex = 0; 
        });
        _refreshAnalytics(); 
      }
    } catch (e) {
      ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text("Error: $e")));
    } finally {
      if (mounted) setState(() => isSubmitting = false);
    }
  }

  // --- UI BUILDING ---
  @override
  Widget build(BuildContext context) {
    // Wrap entire app in Directionality to handle RTL for Arabic
    return Directionality(
      textDirection: _isArabic ? TextDirection.rtl : TextDirection.ltr,
      child: Scaffold(
        appBar: AppBar(
          title: Text(t('app_title')),
          backgroundColor: Colors.white,
          elevation: 0,
          titleTextStyle: const TextStyle(color: Colors.black, fontWeight: FontWeight.bold, fontSize: 20),
          actions: [
             // LANGUAGE TOGGLE BUTTON
            TextButton.icon(
              onPressed: _toggleLanguage,
              icon: const Icon(Icons.language, color: Colors.blue),
              label: Text(_isArabic ? "EN" : "عربي", style: const TextStyle(fontWeight: FontWeight.bold, color: Colors.blue)),
            ),
            IconButton(
              icon: const Icon(Icons.refresh, color: Colors.grey),
              onPressed: _refreshAnalytics,
            ),
            IconButton(
              icon: const Icon(Icons.logout, color: Colors.black),
              onPressed: () async {
                await FirebaseAuth.instance.signOut();
                if (mounted) Navigator.pushReplacement(context, MaterialPageRoute(builder: (_) => const AuthWrapper()));
              },
            )
          ],
        ),
        body: IndexedStack(
          index: _selectedIndex,
          children: [
            _buildDashboardTab(),
            _buildReportFormTab(),
            _buildProfileTab(),
          ],
        ),
        bottomNavigationBar: NavigationBar(
          selectedIndex: _selectedIndex,
          onDestinationSelected: (idx) => setState(() => _selectedIndex = idx),
          destinations: [
            NavigationDestination(icon: const Icon(Icons.dashboard_outlined), selectedIcon: const Icon(Icons.dashboard), label: t('nav_analytics')),
            NavigationDestination(icon: const Icon(Icons.add_circle_outline), selectedIcon: const Icon(Icons.add_circle), label: t('nav_new_report')),
            NavigationDestination(icon: const Icon(Icons.person_outline), selectedIcon: const Icon(Icons.person), label: t('nav_profile')),
          ],
        ),
      ),
    );
  }

  // 1. DASHBOARD TAB
  Widget _buildDashboardTab() {
    if (_loadingAnalytics) return const Center(child: CircularProgressIndicator());
    if (_areaRisks.isEmpty && _teamPerformance.isEmpty && _typeStats.isEmpty) {
       return Center(child: Column(
         mainAxisAlignment: MainAxisAlignment.center,
         children: [
           const Icon(Icons.analytics_outlined, size: 60, color: Colors.grey),
           const SizedBox(height: 16),
           Text(_errorMsg.isEmpty ? t('dash_no_data') : _errorMsg, textAlign: TextAlign.center),
           ElevatedButton(onPressed: _refreshAnalytics, child: Text(t('dash_retry')))
         ],
       ));
    }

    return RefreshIndicator(
      onRefresh: _refreshAnalytics,
      child: ListView(
        padding: const EdgeInsets.all(16),
        children: [
          _buildUserPerformanceCard(),
          const SizedBox(height: 24),

          // Row for Pie Charts (Risk Levels & Types)
          Row(
            children: [
                Expanded(child: _buildPieChartSection(t('dash_risk_levels'), _levelStats, true)),
                const SizedBox(width: 16),
                Expanded(child: _buildPieChartSection(t('dash_issue_types'), _typeStats, false)),
            ],
          ),
          const SizedBox(height: 24),

          // Horizontal Bar Chart for Hazard Kinds
          Text(t('dash_hazard_kinds'), style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
          const SizedBox(height: 10),
          _buildHorizontalBarChart(_hazardStats, Colors.orangeAccent),
          const SizedBox(height: 24),
          
          // Electrical Kinds
          Text(t('dash_elec_issues'), style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
          const SizedBox(height: 10),
          _buildHorizontalBarChart(_elecStats, Colors.blueAccent),
          const SizedBox(height: 24),

          // Area Hotspots
          Text(t('dash_hotspots'), style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
          const SizedBox(height: 10),
          _buildAreaRiskChart(),
          const SizedBox(height: 24),

          // Team Performance
          Text(t('dash_team_rates'), style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
          const SizedBox(height: 10),
          ..._teamPerformance.map((team) => _buildTeamListTile(team)),
        ],
      ),
    );
  }

  // --- User Performance Card ---
  Widget _buildUserPerformanceCard() {
    if (_userPerformance == null) return const SizedBox.shrink();
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        gradient: LinearGradient(colors: [Colors.blue.shade800, Colors.blue.shade500]),
        borderRadius: BorderRadius.circular(16),
        boxShadow: [BoxShadow(color: Colors.blue.withOpacity(0.3), blurRadius: 10, offset: const Offset(0, 4))]
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(t('dash_perf_card'), style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold, fontSize: 18)),
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
                decoration: BoxDecoration(color: Colors.white.withOpacity(0.2), borderRadius: BorderRadius.circular(20)),
                child: Text(_userPerformance!.rank, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold)),
              )
            ],
          ),
          const SizedBox(height: 20),
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceAround,
            children: [
              _buildUserStatItem(t('dash_submitted'), "${_userPerformance!.totalSubmitted}", Icons.upload_file),
              _buildUserStatItem(t('dash_pending'), "${_userPerformance!.pending}", Icons.pending_actions),
              _buildUserStatItem(t('dash_closed'), "${_userPerformance!.closed}", Icons.check_circle_outline),
            ],
          )
        ],
      ),
    );
  }

  Widget _buildUserStatItem(String label, String value, IconData icon) {
    return Column(
      children: [
        Icon(icon, color: Colors.white70, size: 28),
        const SizedBox(height: 8),
        Text(value, style: const TextStyle(color: Colors.white, fontSize: 22, fontWeight: FontWeight.bold)),
        Text(label, style: const TextStyle(color: Colors.white70, fontSize: 12)),
      ],
    );
  }

  // --- Horizontal Bar Chart Widget ---
  Widget _buildHorizontalBarChart(List<CategoryMetric> stats, Color color) {
    if (stats.isEmpty) return Text(t('dash_no_data'));
    final topStats = stats.take(5).toList();
    final maxVal = topStats.isEmpty ? 10 : topStats.map((e) => e.count).reduce(max);
    
    return Column(
      children: topStats.map((item) {
        final pct = item.count / maxVal;
        return Padding(
          padding: const EdgeInsets.symmetric(vertical: 4.0),
          child: Row(
            children: [
              // Translate hazard label if possible? For now, we keep API text as is or could map known ones
              SizedBox(width: 80, child: Text(item.label.length > 10 ? "${item.label.substring(0,8)}.." : item.label, style: const TextStyle(fontSize: 12))),
              Expanded(
                child: Stack(
                  children: [
                    Container(height: 20, decoration: BoxDecoration(color: Colors.grey.shade100, borderRadius: BorderRadius.circular(4))),
                    FractionallySizedBox(
                      widthFactor: pct,
                      child: Container(height: 20, decoration: BoxDecoration(color: color, borderRadius: BorderRadius.circular(4))),
                    )
                  ],
                ),
              ),
              const SizedBox(width: 8),
              Text("${item.count}", style: const TextStyle(fontWeight: FontWeight.bold))
            ],
          ),
        );
      }).toList(),
    );
  }

  // --- Pie Chart Widget ---
  Widget _buildPieChartSection(String title, List<CategoryMetric> stats, bool isLevel) {
    return Container(
      padding: const EdgeInsets.all(12),
      height: 220,
      decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(12), boxShadow: [BoxShadow(color: Colors.grey.withOpacity(0.1), blurRadius: 8)]),
      child: Column(
        children: [
            Text(title, style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 14)),
            const SizedBox(height: 10),
            Expanded(
              child: stats.isEmpty ? const Center(child: Text("--")) : PieChart(
                PieChartData(
                  sectionsSpace: 0,
                  centerSpaceRadius: 30,
                  sections: stats.map((e) {
                    final color = isLevel 
                       ? (e.label == 'High' ? Colors.red : (e.label == 'Medium' ? Colors.orange : Colors.green))
                       : Colors.primaries[stats.indexOf(e) % Colors.primaries.length];
                    return PieChartSectionData(
                      color: color,
                      value: e.count.toDouble(),
                      title: "${e.count}",
                      radius: 40,
                      titleStyle: const TextStyle(fontSize: 12, fontWeight: FontWeight.bold, color: Colors.white),
                    );
                  }).toList(),
                )
              ),
            ),
            const SizedBox(height: 4),
            // Simple Legend with Translation for labels if possible
            Wrap(
              spacing: 8,
              children: stats.take(3).map((e) {
                // Translate Label if it's a known Level
                 String label = isLevel ? trVal(e.label, _levelTr) : e.label;
                 return Row(mainAxisSize: MainAxisSize.min, children: [
                    Container(width: 8, height: 8, color: isLevel 
                          ? (e.label == 'High' ? Colors.red : (e.label == 'Medium' ? Colors.orange : Colors.green))
                          : Colors.primaries[stats.indexOf(e) % Colors.primaries.length],),
                    const SizedBox(width: 4),
                    Text(label, style: const TextStyle(fontSize: 10))
                 ]);
              }).toList()
            )
        ],
      ),
    );
  }

  // Area Chart
  Widget _buildAreaRiskChart() {
    double maxRisk = _areaRisks.isNotEmpty 
        ? _areaRisks.map((e) => e.totalRiskScore).reduce(max) 
        : 10.0;
    if (maxRisk == 0) maxRisk = 10.0;

    return Container(
            height: 200,
            padding: const EdgeInsets.all(12),
            decoration: BoxDecoration(color: Colors.white, borderRadius: BorderRadius.circular(12), boxShadow: [BoxShadow(color: Colors.grey.withOpacity(0.1), blurRadius: 10)]),
            child: _areaRisks.isEmpty ? Center(child: Text(t('dash_no_data'))) : BarChart(
              BarChartData(
                alignment: BarChartAlignment.spaceAround,
                maxY: maxRisk * 1.2,
                titlesData: FlTitlesData(
                  show: true,
                  bottomTitles: AxisTitles(sideTitles: SideTitles(showTitles: true, getTitlesWidget: (val, meta) {
                    if (val.toInt() >= 0 && val.toInt() < _areaRisks.length) {
                      String label = _areaRisks[val.toInt()].area;
                      String disp = trVal(label, _areaTr);
                      return Padding(padding: const EdgeInsets.only(top: 4.0), child: Text(disp.length > 7 ? disp.substring(0, 6) : disp, style: const TextStyle(fontSize: 9)));
                    }
                    return const SizedBox.shrink();
                  })),
                  leftTitles: const AxisTitles(sideTitles: SideTitles(showTitles: false)),
                  topTitles: const AxisTitles(sideTitles: SideTitles(showTitles: false)),
                  rightTitles: const AxisTitles(sideTitles: SideTitles(showTitles: false)),
                ),
                gridData: const FlGridData(show: false),
                borderData: FlBorderData(show: false),
                barGroups: _areaRisks.asMap().entries.map((e) => BarChartGroupData(
                  x: e.key,
                  barRods: [BarChartRodData(toY: e.value.totalRiskScore, color: e.value.totalRiskScore > 20 ? Colors.red : (e.value.totalRiskScore > 10 ? Colors.orange : Colors.blue), width: 14, borderRadius: BorderRadius.circular(4))]
                )).toList(),
              ),
            ),
    );
  }

  Widget _buildTeamListTile(TeamMetric team) {
    // Translate Dept Name if in our list
    String deptName = trVal(team.department, _deptTr);
    
    return Card(
      elevation: 0,
      color: Colors.grey.shade50,
      margin: const EdgeInsets.only(bottom: 8),
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8), side: BorderSide(color: Colors.grey.shade200)),
      child: ListTile(
        leading: CircularProgressIndicator(
          value: team.closureRate / 100, 
          backgroundColor: Colors.grey.shade200, 
          color: team.closureRate > 75 ? Colors.green : (team.closureRate > 40 ? Colors.orange : Colors.red),
        ),
        title: Text(deptName, style: const TextStyle(fontWeight: FontWeight.bold)),
        subtitle: Text("${team.closedReports} ${t('dash_closed')} / ${team.totalReports} ${t('dash_submitted')}"),
        trailing: Text("${team.closureRate.toStringAsFixed(1)}%", style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
      ),
    );
  }

  // 2. REPORT FORM TAB
  Widget _buildReportFormTab() {
    return SingleChildScrollView(
      padding: const EdgeInsets.all(20),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(t('form_title'), style: const TextStyle(fontSize: 24, fontWeight: FontWeight.bold)),
          Text(t('form_subtitle'), style: const TextStyle(color: Colors.grey)),
          const SizedBox(height: 20),

          DropdownButtonFormField<String>(
            value: selectedArea,
            items: _areas.map((e) => DropdownMenuItem(
              value: e, 
              child: Text(trVal(e, _areaTr))
            )).toList(),
            onChanged: (v) => setState(() => selectedArea = v),
            decoration: InputDecoration(labelText: t('form_area'), border: const OutlineInputBorder(), prefixIcon: const Icon(Icons.place)),
          ),
          const SizedBox(height: 16),

          TextField(
            controller: _observationController,
            maxLines: 4,
            onChanged: _onObservationChanged,
            decoration: InputDecoration(
              labelText: t('form_desc_hint'),
              alignLabelWithHint: true,
              border: const OutlineInputBorder(),
              suffixIcon: _isAnalyzing 
                ? const Padding(padding: EdgeInsets.all(12), child: CircularProgressIndicator(strokeWidth: 2)) 
                : const Icon(Icons.description),
            ),
          ),
          
          // --- DUPLICATE WARNING WIDGET ---
          if (_duplicateWarning != null)
             Container(
               margin: const EdgeInsets.only(top: 10),
               padding: const EdgeInsets.all(12),
               decoration: BoxDecoration(color: Colors.orange.shade50, borderRadius: BorderRadius.circular(8), border: Border.all(color: Colors.orange.shade200)),
               child: Row(
                 children: [
                    const Icon(Icons.warning_amber_rounded, color: Colors.orange),
                    const SizedBox(width: 8),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text("${t('form_dup_found')} (${(_similarityScore * 100).toInt()}% match)", style: const TextStyle(fontWeight: FontWeight.bold, color: Colors.orange)),
                          Text(_duplicateWarning!, style: TextStyle(fontSize: 12, color: Colors.orange.shade900), maxLines: 2, overflow: TextOverflow.ellipsis),
                        ],
                      ),
                    )
                 ],
               ),
             ),

          const SizedBox(height: 24),
          Text(t('form_ai_section'), style: const TextStyle(fontWeight: FontWeight.bold, fontSize: 16)),
          const SizedBox(height: 8),

          Row(
            children: [
              Expanded(
                child: DropdownButtonFormField<String>(
                  value: selectedLevel,
                  items: ["Low", "Medium", "High"].map((e) => DropdownMenuItem(
                    value: e, 
                    child: Text(trVal(e, _levelTr))
                  )).toList(),
                  onChanged: (v) => setState(() => selectedLevel = v),
                  decoration: InputDecoration(labelText: t('form_risk_level'), filled: true, fillColor: const Color(0xFFFAFAFA)),
                ),
              ),
              const SizedBox(width: 12),
              Expanded(
                child: DropdownButtonFormField<String>(
                  value: selectedType,
                  items: ["Unsafe_Condition", "Unsafe_Behavior", "NM", "FA"].map((e) => DropdownMenuItem(
                    value: e, 
                    child: Text(trVal(e, _typeTr))
                  )).toList(),
                  onChanged: (v) => setState(() => selectedType = v),
                  decoration: InputDecoration(labelText: t('form_type'), filled: true, fillColor: const Color(0xFFFAFAFA)),
                ),
              ),
            ],
          ),
          const SizedBox(height: 12),
          TextFormField(
            key: ValueKey('hazard_$selectedHazardKind'), 
            initialValue: selectedHazardKind,
            readOnly: true,
            decoration: InputDecoration(labelText: t('form_hazard_kind'), filled: true, fillColor: const Color(0xFFF0F0F0), border: const OutlineInputBorder()),
          ),
          const SizedBox(height: 12),
          TextFormField(
            key: ValueKey('electrical_$selectedElectricalKind'), 
            initialValue: selectedElectricalKind,
            readOnly: true,
            decoration: InputDecoration(labelText: t('form_elec_kind'), filled: true, fillColor: const Color(0xFFF0F0F0), border: const OutlineInputBorder()),
          ),
          const SizedBox(height: 12),
          DropdownButtonFormField<String>(
            value: selectedDept,
            items: _departments.map((e) => DropdownMenuItem(
              value: e, 
              child: Text(trVal(e, _deptTr))
            )).toList(),
            onChanged: (v) => setState(() => selectedDept = v),
            decoration: InputDecoration(labelText: t('form_dept'), border: const OutlineInputBorder()),
          ),

          const SizedBox(height: 32),
          SizedBox(
            width: double.infinity,
            height: 50,
            child: ElevatedButton.icon(
              style: ElevatedButton.styleFrom(backgroundColor: AppColors.primary, foregroundColor: Colors.white),
              onPressed: isSubmitting ? null : _submitReport,
              icon: isSubmitting ? const SizedBox(width: 20, height: 20, child: CircularProgressIndicator(color: Colors.white, strokeWidth: 2)) : const Icon(Icons.send),
              label: Text(t('form_submit')),
            ),
          ),
        ],
      ),
    );
  }

  // 3. PROFILE TAB
  Widget _buildProfileTab() {
    final user = FirebaseAuth.instance.currentUser;
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          CircleAvatar(radius: 40, backgroundColor: AppColors.primary.withOpacity(0.2), child: Text(user?.email?.substring(0, 1).toUpperCase() ?? "U", style: TextStyle(fontSize: 32, color: AppColors.primary))),
          const SizedBox(height: 16),
          Text(user?.email ?? t('guest'), style: const TextStyle(fontSize: 18, fontWeight: FontWeight.bold)),
          const SizedBox(height: 8),
          Text(t('role'), style: const TextStyle(color: Colors.grey)),
          const SizedBox(height: 32),
          // User stats could be repeated here or show account settings
          OutlinedButton(onPressed: () {}, child: Text(t('edit_profile'))),
        ],
      ),
    );
  }
}